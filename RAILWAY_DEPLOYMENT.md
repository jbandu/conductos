# Railway Deployment Guide - ConductOS

This guide will help you deploy both the client and server on Railway as a single unified service.

## Architecture Overview

**Unified Deployment Strategy:**
- Single Railway service runs the Node.js server
- Server serves both API endpoints (`/api/*`) and static client files
- Client is built during deployment and served from `client/dist`
- PostgreSQL database provided by Railway

## Prerequisites

1. Railway account (https://railway.app)
2. Railway CLI installed: `npm install -g @railway/cli`
3. Git repository pushed to GitHub/GitLab

## Step 1: Create Railway Project

```bash
# Login to Railway
railway login

# Create new project
cd /home/jbandu/github/conductos
railway init
```

Select: **"Create a new project"**

## Step 2: Add PostgreSQL Database

In Railway Dashboard:
1. Click **"+ New"** → **"Database"** → **"PostgreSQL"**
2. Wait for database to provision
3. Copy the `DATABASE_URL` from the database connection info

## Step 3: Configure Environment Variables

In Railway Dashboard → Your Service → **Variables** tab, add:

### Required Environment Variables

```bash
# Database (Auto-generated by Railway PostgreSQL - verify it's correct)
DATABASE_URL=postgresql://postgres:PASSWORD@HOST:PORT/railway

# Server Configuration
NODE_ENV=production
PORT=3001

# Client URL (Update after deployment with your actual Railway URL)
CLIENT_URL=https://your-app-name.railway.app
```

### How to Find Your Railway URL

After first deployment, Railway will give you a URL like:
- `https://conductos-production-xxxx.up.railway.app`

Update `CLIENT_URL` with this URL.

## Step 4: Configure Railway Build Settings

In Railway Dashboard → Your Service → **Settings** tab:

### Root Directory
Leave empty (use project root)

### Build Command
```bash
npm run railway:build
```

This command:
1. Installs all dependencies
2. Builds the Vite client to `client/dist`

### Start Command
```bash
npm run railway:start
```

This command:
1. Installs server dependencies
2. Starts the Express server
3. Server serves both API and static client files

### Watch Paths (Optional)
```
server/**
client/**
package.json
```

## Step 5: Deploy

```bash
# Deploy from local
railway up

# Or connect to GitHub and auto-deploy
# In Railway Dashboard → Settings → Connect GitHub repo
```

## Step 6: Initialize Database

After first deployment, initialize the database schema:

```bash
# Set Railway environment in terminal
railway run npm run db:init
```

This creates the `cases` and `status_history` tables.

## Step 7: Seed Test Data

```bash
# Seed the database with 12 test cases
railway run npm run db:seed
```

This adds:
- 12 cases with various statuses
- 2 overdue cases (KELP-2025-0003, KELP-2025-0004)
- Mix of anonymous and named complainants

## Step 8: Verify Deployment

1. **Open your Railway URL**: `https://your-app-name.railway.app`
2. **Test Employee Mode**:
   - Type: "What is PoSH?"
   - Should get informative response
3. **Test IC Mode**:
   - Click "IC Mode" in sidebar
   - Click "Show All Cases"
   - Should see 12 cases
   - Click "Overdue" - should see 2 overdue cases with alert
4. **Test API Health**:
   - Visit: `https://your-app-name.railway.app/api/health`
   - Should return: `{"status":"ok","message":"KelpHR ConductOS API is running"}`

## Environment Variables - Complete Reference

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | Yes | - | PostgreSQL connection string from Railway database |
| `NODE_ENV` | Yes | `production` | Environment mode (must be "production" on Railway) |
| `PORT` | No | `3001` | Server port (Railway may override with $PORT) |
| `CLIENT_URL` | Yes | - | Your Railway app URL for CORS (e.g., https://conductos-production.up.railway.app) |

## Project Structure

```
conductos/
├── client/               # React frontend
│   ├── dist/            # Built files (created during deployment)
│   ├── src/
│   └── package.json
├── server/              # Express backend
│   ├── db/
│   │   ├── pg-init.js   # Database schema
│   │   └── seed.js      # Test data
│   ├── routes/
│   ├── services/
│   ├── index.js         # Main server file (serves API + static files)
│   └── package.json
└── package.json         # Root workspace config
```

## How It Works

### Development (Local)
```bash
npm run dev
```
- Runs Vite dev server on port 5173
- Runs Express server on port 3001
- Vite proxy forwards `/api` requests to Express

### Production (Railway)
```bash
npm run railway:build  # Builds client to client/dist
npm run railway:start  # Starts Express server
```
- Express server runs on Railway's assigned port
- Serves API endpoints at `/api/*`
- Serves built client files for all other routes
- Single unified service

## Troubleshooting

### Issue: "Cannot connect to database"
**Solution**: Verify `DATABASE_URL` environment variable is set correctly in Railway dashboard

### Issue: "CORS errors in browser console"
**Solution**: Update `CLIENT_URL` environment variable with your actual Railway URL

### Issue: "404 for static assets"
**Solution**:
1. Check build ran successfully: `railway logs`
2. Verify `client/dist` exists after build
3. Ensure `NODE_ENV=production` is set

### Issue: "API works but UI shows blank page"
**Solution**:
1. Check browser console for errors
2. Verify build output: `railway logs`
3. Check `client/dist/index.html` exists

### Issue: "Database tables don't exist"
**Solution**: Run `railway run npm run db:init` to create schema

## Updating Deployment

### Update Code
```bash
git add .
git commit -m "Your commit message"
git push origin main
```

If GitHub auto-deploy is connected, Railway will automatically redeploy.

### Update Database Schema
```bash
# After modifying pg-init.js
railway run npm run db:init
```

### Re-seed Database
```bash
railway run npm run db:seed
```

## Database Management

### Connect to Railway PostgreSQL

```bash
# Using Railway CLI
railway connect postgresql

# Or using psql directly
psql "$DATABASE_URL"
```

### Useful SQL Commands

```sql
-- View all cases
SELECT case_code, status, incident_date, deadline_date FROM cases ORDER BY created_at DESC;

-- Count cases by status
SELECT status, COUNT(*) FROM cases GROUP BY status;

-- Find overdue cases
SELECT case_code, deadline_date,
       CURRENT_DATE - deadline_date as days_overdue
FROM cases
WHERE deadline_date < CURRENT_DATE;

-- View case history
SELECT c.case_code, sh.old_status, sh.new_status, sh.changed_at
FROM status_history sh
JOIN cases c ON sh.case_id = c.id
ORDER BY sh.changed_at DESC
LIMIT 20;
```

## Cost Optimization

Railway free tier includes:
- $5 of usage per month
- Unlimited projects
- PostgreSQL database

**Tips to stay within free tier:**
1. Use Hobby plan for database (pauses after 7 days of inactivity)
2. Deploy only when ready to test
3. Remove old/test deployments

## Security Checklist

Before sharing with friends:

- [ ] `DATABASE_URL` contains strong password
- [ ] `NODE_ENV` set to `production`
- [ ] CORS `CLIENT_URL` matches actual Railway URL
- [ ] No sensitive data in test cases
- [ ] Database initialized with `db:init`
- [ ] Test data seeded appropriately
- [ ] API endpoints tested and working
- [ ] UI loads and functions correctly
- [ ] Mobile responsive design verified

## Support & Debugging

### View Logs
```bash
railway logs
```

### Monitor Service
Railway Dashboard → Your Service → **Metrics** tab

### Common Log Messages to Look For

✅ **Success:**
```
Creating PostgreSQL connection pool...
Initializing database schema...
Database schema initialized successfully
Server is running on port 3001
Environment: production
```

❌ **Errors:**
```
Error: DATABASE_URL environment variable is not set
Failed to initialize database
ECONNREFUSED
```

## Next Steps After Deployment

1. Share Railway URL with friends for testing
2. Collect feedback on functionality
3. Monitor Railway logs for errors
4. Plan for custom domain (if needed)
5. Set up monitoring/alerting
6. Plan production security enhancements:
   - Add authentication
   - Implement rate limiting
   - Add input validation
   - Enable audit logging

## Quick Reference Commands

```bash
# Deploy
railway up

# View logs
railway logs

# Initialize database
railway run npm run db:init

# Seed database
railway run npm run db:seed

# Connect to database
railway connect postgresql

# Open deployed app
railway open
```

---

**Deployment Status**: Ready to deploy!

After following this guide, your app will be live at:
`https://your-app-name.railway.app`
